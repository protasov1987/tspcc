<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Сводная таблица операций</title>
  <style>
    @page { size: A4 landscape; margin: 20mm; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: left; vertical-align: top; }
    thead { background: #f3f4f6; }
    .op-qty-row td { background: #f9fafb; }
    .qty-row-content { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .qty-row-content label { font-weight: 600; }
    .items-row-content { display: flex; flex-wrap: wrap; gap: 8px; }
    .item-block { border: 1px solid #d1d5db; padding: 6px; border-radius: 6px; background: #f3f4f6; min-width: 180px; }
    .item-name { font-weight: 700; }
    .item-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .barcode-print { display: flex; align-items: center; gap: 12px; margin: 8px 0; padding: 5mm; }
    .barcode-print .barcode-svg { padding: 5mm; }
    .meta-print { margin: 2px 0; font-size: 13px; }
    .meta-stack { display: flex; flex-direction: column; gap: 2px; }
    .summary-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .summary-header .meta-stack { align-items: flex-end; text-align: right; }
    .barcode-print svg { width: 50mm; height: 20mm; display: block; }
  </style>
</head>
<body>
  <h2><%= escapeHtml(card.name || '') %></h2>
  <div class="summary-header">
    <div class="barcode-print">
      <div class="barcode-svg"><%- barcodeSvg %></div>
      <div class="meta-stack">
        <div class="meta-print"><strong>Код МК:</strong> <%= escapeHtml(barcodeValue || card.routeCardNumber || '') %></div>
        <div class="meta-print"><strong>Заказ:</strong> <%= escapeHtml(card.orderNo || '') %></div>
      </div>
    </div>
    <div class="meta-stack">
      <div class="meta-print"><strong>Количество, шт:</strong> <%= escapeHtml(formatQuantityValue(card.quantity)) %></div>
      <div class="meta-print"><strong>Чертёж / обозначение:</strong> <%= escapeHtml(card.drawing || '') %></div>
      <div class="meta-print"><strong>Материал:</strong> <%= escapeHtml(card.material || '') %></div>
      <div class="meta-print"><strong>Описание:</strong> <%= escapeHtml(card.desc || '') %></div>
      <div class="meta-print"><strong>Статус:</strong> <%= escapeHtml(cardStatusText(card)) %></div>
    </div>
  </div>
  <div><%- summaryHtml %></div>
  <script>
    (function () {
      let fired = false;
      window.addEventListener('load', () => {
        if (fired) return;
        fired = true;
        setTimeout(() => window.print(), 250);
      });
      window.addEventListener('afterprint', () => {
        window.close();
      });
    })();
  </script>
</body>
</html>

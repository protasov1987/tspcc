# AGENTS.md — Rules for Codex (tspcc-main)

Этот файл содержит обязательные архитектурные правила.
Нарушение любого пункта считается ошибкой, даже если “что-то работает”.

---

## Absolute Rules (MUST)

### A1. URL is the source of truth
- При загрузке страницы (включая F5 и прямой заход) приложение ОБЯЗАНО
  отрисовать состояние согласно:
  window.location.pathname + window.location.search.
- Запрещено показывать “dashboard по умолчанию”, если URL указывает на другую страницу.

### A2. Session-first bootstrap
- Любой роутинг, рендер страниц и инициализация UI,
  зависящие от авторизации, ДОЛЖНЫ выполняться ТОЛЬКО ПОСЛЕ:
  restoreSession() / checkAuth().
- Пока сессия не восстановлена — разрешён только loader / overlay,
  но не контент страниц.

### A3. Single bootstrap pipeline
- В приложении должен существовать ОДИН основной сценарий bootstrap
  (инициализация при загрузке страницы).
- Запрещены параллельные или дублирующие boot-процессы
  в разных файлах или событиях.

### A4. popstate is mandatory
- Обработчик window.popstate ОБЯЗАН вызывать:
  handleRoute(fullPath, { fromHistory: true, ... }).
- Back / Forward в браузере должны работать без F5 и без редиректа на dashboard.

### A5. Idempotent initialization
- initNavigation() / setupNavigation() и аналогичные setup-функции
  ОБЯЗАНЫ быть идемпотентными.
- Повторный вызов не должен:
  - вешать обработчики повторно,
  - создавать дубликаты слушателей.
- Обязателен guard-флаг вида:
  navigationSetupDone / alreadyInitialized.

Примечание:
initNavigation и setupNavigation считаются эквивалентными по смыслу;
фактическое имя функции определяется кодом файла.

### A6. No forced redirect on boot
- Запрещено делать безусловный navigate('/dashboard')
  или аналогичный редирект при старте приложения.
- Редирект допустим ТОЛЬКО если:
  - маршрут недоступен,
  - или пользователь не авторизован,
  и это решение принято внутри handleRoute.

### A7. Single page visibility control
- Показ и скрытие страниц должен происходить
  через единый управляющий механизм (роутер / showPage / render через route).
- Запрещено точечно управлять DOM (style.display и т.п.)
  в разных местах без централизованного контроля.

### A8. Boot / Route diagnostics
- Любые изменения, связанные с bootstrap или роутингом,
  ОБЯЗАНЫ сохранять или расширять существующую диагностику.
- Допустимый формат логов:
  [ROUTE] ... или [BOOT] ...
- Логи должны позволять понять:
  где именно загрузка или маршрут “завис”.

---

## Forbidden (MUST NOT)

F1. Нельзя менять window.location для SPA-навигации
    (кроме logout или полной перезагрузки по требованию).
F2. Нельзя вызывать render страницы ДО завершения restoreSession().
F3. Нельзя вызывать handleRoute до навешивания popstate.
F4. Нельзя добавлять новые страницы без регистрации в маршрутизаторе.
F5. Нельзя вешать обработчики меню в обход общего navigation-слоя.

---

## Required Pre-Commit Checklist (MUST pass)

Перед любым коммитом, затрагивающим роутинг или bootstrap:

- [ ] F5 на /dashboard работает
- [ ] F5 на /cards работает
- [ ] F5 на /cards/<id> работает
- [ ] F5 на /profile/<id> или /user/<id> работает
- [ ] Прямой заход по URL работает (без редиректа на dashboard)
- [ ] Back / Forward работает корректно
- [ ] initNavigation / setupNavigation вызывается один раз
- [ ] popstate вызывает handleRoute
- [ ] Нет скрытых редиректов при загрузке страницы

Если менялся порядок bootstrap —
ОБЯЗАТЕЛЬНО обновить docs/architecture/spa-boot.md.
